// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// NextAuth.js 필수 모델
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  emailVerified DateTime?
  image         String?
  preferences   Json      @default("{}")
  role          UserRole  @default(user)
  
  // 2FA Fields
  twoFactorEnabled Boolean  @default(false)
  twoFactorSecret  String?  @db.Text
  twoFactorBackupCodes String? @db.Text

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts      Account[]
  sessions      Session[]
  conversations Conversation[]
  tokenUsages   TokenUsage[]
  apiKeyUsages  ApiKeyUsage[]
  apiKeys       ApiKey[] @relation("UserApiKeys")
  adminAuditLogs AdminAuditLog[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  
  // 2FA Verification Status
  twoFactorVerified Boolean @default(false)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// 애플리케이션 모델 (v1.2 수정)
// ============================================

model Conversation {
  id           String    @id @default(cuid())
  userId       String
  title        String    @default("New Chat")
  model        String    @default("gpt-4o-mini")
  systemPrompt String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages Message[]

  @@index([userId])
  @@index([updatedAt(sort: Desc)])
}

model Message {
  id             String   @id @default(cuid())
  conversationId String
  role           String   // 'user' | 'assistant' | 'system'
  content        String   @db.Text
  tokens         Int?
  
  // v1.2 추가: 버전 관리를 위한 히스토리 (별도 테이블 대체)
  // 형식: [{ content: string, createdAt: string }, ...]
  history        Json     @default("[]")
  
  // v1.2 추가: RAG 확장성 대비 컨텍스트 저장
  // 형식: { sources: [...], embeddings: [...], metadata: {...} }
  context        Json?
  
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
}

model TokenUsage {
  id               String   @id @default(cuid())
  userId           String   // v1.2: Required (Not Null)
  model            String
  promptTokens     Int
  completionTokens Int
  createdAt        DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

// ============================================
// 관리자 키 관리 (v1.2 확장)
// ============================================

enum UserRole {
  admin
  user
}

model ApiKey {
  id           String   @id @default(cuid())
  name         String
  provider     String
  baseUrl      String?
  encryptedKeyJson String @db.Text
  keyHash      String   @unique
  description  String?
  isActive     Boolean  @default(true)
  expiresAt    DateTime?
  lastUsedAt   DateTime?
  usageCount   Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  deletedAt    DateTime?

  createdBy String
  creator   User     @relation("UserApiKeys", fields: [createdBy], references: [id], onDelete: SetNull)

  usages ApiKeyUsage[]
  models Model[]

  @@index([provider, isActive])
}

model ApiKeyUsage {
  id         String   @id @default(cuid())
  apiKeyId   String
  userId     String?
  model      String
  route      String
  createdAt  DateTime @default(now())

  apiKey ApiKey @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)
  user   User?  @relation(fields: [userId], references: [id])

  @@index([apiKeyId])
  @@index([createdAt])
}

model AdminAuditLog {
  id         String   @id @default(cuid())
  userId     String
  action     String
  resource   String
  resourceId String?
  details    String?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([resource, resourceId])
  @@index([createdAt])
}

// ============================================
// 모델 관리 (v1.3 추가)
// ============================================

model Model {
  id          String   @id @default(cuid())
  apiModelId  String   // 외부 API에서의 모델 ID (예: gpt-4-turbo)
  provider    String   // 모델 제공자 (openai, anthropic, google 등)
  name        String   // 표기 이름 (관리자가 수정 가능)
  description String?  // 모델 설명
  
  isEnabled   Boolean  @default(true)  // 사용 가능 여부
  isPublic    Boolean  @default(true)  // 일반 사용자에게 공개 여부
  order       Int      @default(0)     // 표시 순서 (낮을수록 먼저 표시)
  isDefault   Boolean  @default(false) // 기본 선택 모델 여부
  supportsStreaming Boolean @default(false) // 스트림 응답 지원 여부
  
  contextLength Int?   // 컨텍스트 길이 (토큰)
  inputPrice    Float? // 1M 토큰당 입력 가격
  outputPrice   Float? // 1M 토큰당 출력 가격
  
  config      Json?    // 추가 설정 (JSON)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  apiKeyId    String?
  apiKey      ApiKey?  @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  @@unique([provider, apiModelId, apiKeyId]) // 제공자와 모델ID, API Key 조합은 유일해야 함
  @@index([isEnabled, isPublic])
  @@index([order]) // 정렬을 위한 인덱스
}

// ============================================
// 시스템 설정 (v1.4 추가)
// ============================================

model SystemSetting {
  key         String   @id
  value       String   @db.Text
  description String?
  updatedAt   DateTime @updatedAt
  updatedBy   String?  // 수정한 관리자 ID
}
